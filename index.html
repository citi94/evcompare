<!DOCTYPE html>
<!--
    EV vs ICE Cost Calculator
    Copyright Â© 2025 Peter Harding. All rights reserved.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV vs ICE Cost Calculator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Compare fuel costs between Electric Vehicles and Internal Combustion Engine vehicles">
    <meta name="theme-color" content="#3498db">
    <meta name="msapplication-TileColor" content="#3498db">
    <meta name="msapplication-navbutton-color" content="#3498db">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="EV Compare">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232ecc71'/%3E%3Cstop offset='100%25' style='stop-color:%233498db'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='192' height='192' rx='24' fill='url(%23grad)'/%3E%3Ctext x='96' y='80' text-anchor='middle' fill='white' font-size='48' font-weight='bold'%3Eâš¡%3C/text%3E%3Ctext x='96' y='130' text-anchor='middle' fill='white' font-size='24' font-weight='bold'%3Evs%3C/text%3E%3Ctext x='96' y='165' text-anchor='middle' fill='white' font-size='32' font-weight='bold'%3Eâ›½%3C/text%3E%3C/svg%3E">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232ecc71'/%3E%3Cstop offset='100%25' style='stop-color:%233498db'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='4' fill='url(%23grad)'/%3E%3Ctext x='16' y='22' text-anchor='middle' fill='white' font-size='18' font-weight='bold'%3Eâš¡%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
            position: relative;
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ev-section .section-title {
            color: #3498db;
        }

        .petrol-section .section-title {
            color: #e74c3c;
        }

        .slider-group {
            margin-bottom: 25px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .value-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unit-label {
            font-size: 0.9em;
            color: #7f8c8d;
            font-weight: 500;
            white-space: nowrap;
        }

        .label-text {
            font-weight: 500;
            color: #34495e;
        }


        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            outline: none;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            background: #dfe6e9;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 2px 15px rgba(52, 152, 219, 0.5);
        }

        .petrol-section input[type="range"]::-webkit-slider-thumb {
            background: #e74c3c;
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
        }

        .petrol-section input[type="range"]::-webkit-slider-thumb:hover {
            box-shadow: 0 2px 15px rgba(231, 76, 60, 0.5);
        }

        .lock-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #3498db;
            position: relative;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: white;
            border: 2px solid #ddd;
            border-radius: 2px;
        }

        .lock-checkbox:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .lock-checkbox::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            background: #f8f9fa;
            border-radius: 2px;
        }

        .lock-checkbox:checked {
            background: transparent;
            border: none;
        }

        .lock-checkbox:checked::after {
            content: 'ðŸ”’';
            opacity: 1;
        }

        .petrol-section .lock-checkbox {
            accent-color: #e74c3c;
        }

        .options-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .option-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .option-group:last-child {
            margin-bottom: 0;
        }

        .option-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #34495e;
        }

        .efficiency-input {
            width: 60px;
            padding: 5px;
            border: 2px solid #dfe6e9;
            border-radius: 5px;
            font-size: 1em;
            text-align: center;
            transition: border-color 0.3s ease;
        }

        .efficiency-input:focus {
            border-color: #3498db;
            outline: none;
        }

        .value-display {
            font-weight: 700;
            font-size: 1.1em;
            color: #2c3e50;
            width: 75px;
            text-align: right;
            border: 2px solid transparent;
            border-radius: 5px;
            padding: 4px 8px;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .value-display:hover {
            background: rgba(255, 255, 255, 0.8);
            border-color: #dfe6e9;
        }

        .value-display:focus {
            background: white;
            outline: none;
            cursor: text;
        }

        .ev-section .value-display:focus {
            border-color: #3498db;
        }

        .petrol-section .value-display:focus {
            border-color: #e74c3c;
        }

        /* Hide number input spinner arrows */
        .value-display::-webkit-outer-spin-button,
        .value-display::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .value-display[type=number] {
            -moz-appearance: textfield;
        }

        .equivalence-display {
            background: linear-gradient(135deg, #2ecc71 0%, #3498db 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.3);
            margin-top: 30px;
        }

        .icon {
            width: 24px;
            height: 24px;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .calculator-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 15px;
                margin: 10px;
                max-width: calc(100vw - 20px);
            }
            
            .section {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .options-section {
                padding: 20px;
            }
            
            .usage-calculator {
                padding: 20px;
                margin: 20px 0;
            }
            
            .equivalence-display {
                padding: 15px;
                margin-top: 20px;
                font-size: 1.1em;
            }
            
            .lock-explanation {
                padding: 15px;
                margin: 20px 0;
            }
        }

        /* Mobile portrait and narrow screens - remove outer container styling */
        @media (max-width: 480px), (max-height: 800px) and (max-width: 768px) {
            body {
                padding: 0;
                background: #f8f9fa;
            }
            
            .container {
                background: transparent;
                box-shadow: none;
                border-radius: 0;
                backdrop-filter: none;
                padding: 10px;
                margin: 0;
                max-width: 100vw;
                width: 100%;
            }
            
            .section {
                background: white;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            .options-section {
                background: white;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            .usage-calculator {
                background: white;
                border-radius: 10px;
                padding: 15px;
                margin: 15px 0;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            .lock-explanation {
                background: white;
                border-radius: 10px;
                padding: 15px;
                margin: 15px 0;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            h1, .subtitle {
                padding: 0 10px;
            }
        }

        /* Unit selector styles */
        .unit-selector {
            margin-top: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 10px;
        }

        .unit-select {
            padding: 2px 5px;
            border: 1px solid #dfe6e9;
            border-radius: 3px;
            font-size: 0.8em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
            margin-left: 5px;
        }

        .unit-select:focus {
            border-color: #3498db;
            outline: none;
        }


        .unit-label {
            font-size: 0.9em;
            color: #7f8c8d;
            font-weight: 500;
            white-space: nowrap;
        }

        .lock-explanation {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            color: #7f8c8d;
            font-size: 0.9em;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .usage-calculator {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 30px 0;
            transition: all 0.3s ease;
        }

        .usage-calculator:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .usage-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
            font-weight: 600;
        }

        .usage-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 0;
        }

        .usage-input-group, .usage-output-group {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .usage-label {
            font-weight: 500;
            color: #34495e;
        }


        .usage-select {
            padding: 8px 12px;
            border: 2px solid #dfe6e9;
            border-radius: 5px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .usage-select:focus {
            border-color: #3498db;
            outline: none;
        }

        .usage-results {
            background: linear-gradient(135deg, #3498db 0%, #2ecc71 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
        }

        .usage-cost-display {
            text-align: center;
        }

        .usage-cost-value {
            font-weight: 600;
            font-size: 1.2em;
            color: white;
        }

        @media (max-width: 768px) {
            .usage-input-group, .usage-output-group {
                flex-direction: column;
                gap: 8px;
            }
            
            .usage-inputs {
                gap: 20px;
            }
            
            .slider-label {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .value-container {
                display: grid;
                grid-template-columns: auto auto 1fr;
                gap: 8px;
                align-items: center;
                width: 100%;
            }
            
            .value-display {
                width: auto;
                min-width: 60px;
            }
            
            .usage-label {
                font-size: 0.9em;
                white-space: nowrap;
            }
            
            .usage-select {
                min-width: 0;
                flex-shrink: 1;
            }
        }

        .copyright {
            text-align: center;
            margin-top: 15px;
            padding: 15px;
            color: #7f8c8d;
            font-size: 0.9em;
            border-top: 1px solid #ecf0f1;
        }

        /* Mode toggle button styles */
        .mode-toggle-btn {
            background: linear-gradient(135deg, #3498db 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 40px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            width: fit-content;
            height: fit-content;
            margin: 0;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) rotate(180deg);
            z-index: 10;
        }

        .mode-toggle-btn:hover {
            transform: translate(-50%, -50%) rotate(180deg) scale(1.05);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .mode-toggle-btn:active {
            transform: translate(-50%, -50%) rotate(180deg) scale(0.95);
        }

        .mode-toggle-btn.comparison-mode {
            background: linear-gradient(135deg, #e74c3c 0%, #f39c12 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .mode-toggle-btn.comparison-mode:hover {
            transform: translate(-50%, -50%) rotate(180deg) scale(1.05);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }


        /* Split display styles */
        .cost-split {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
            text-align: center;
        }

        .cost-ev, .cost-ice {
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            color: white;
        }

        .cost-ev {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .cost-ice {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .cost-separator {
            font-size: 1.5em;
            color: white;
            font-weight: bold;
        }

        .savings-display {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(39, 174, 96, 0.3);
            margin-top: 20px;
        }

        .savings-display.ice-cheaper {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
        }

        /* Mobile responsive adjustments for split displays */
        @media (max-width: 480px) {
            .cost-split {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .cost-separator {
                font-size: 1.2em;
                transform: rotate(90deg);
            }
            
            .mode-toggle-btn {
                padding: 30px 10px;
                font-size: 0.75em;
                position: relative;
                left: auto;
                top: auto;
                transform: none;
                writing-mode: horizontal-tb;
                text-orientation: initial;
                margin: 15px auto;
                display: block;
            }
            
            .mode-toggle-btn:hover {
                transform: scale(1.05);
            }
            
            .mode-toggle-btn.comparison-mode:hover {
                transform: scale(1.05);
            }
            
            .savings-display {
                padding: 15px;
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EV vs ICE Calculator</h1>
        <p class="subtitle">Compare fuel costs between electric and internal combustion vehicles</p>

        <div class="calculator-grid">
            <div class="section ev-section">
                <h2 class="section-title">
                    <span class="icon">âš¡</span>
                    Electric Vehicle
                </h2>
                
                <div class="slider-group">
                    <div class="slider-label">
                        <span class="label-text">Efficiency</span>
                        <div class="value-container">
                            <input type="number" class="value-display" id="ev-efficiency-display" value="4.0" step="0.1" min="0.1">
                            <select id="ev-efficiency-unit" class="unit-select">
                                <option value="mi/kWh">mi/kWh</option>
                                <option value="km/kWh">km/kWh</option>
                                <option value="kWh/100mi">kWh/100mi</option>
                                <option value="kWh/100km">kWh/100km</option>
                                <option value="Wh/mi">Wh/mi</option>
                                <option value="Wh/km">Wh/km</option>
                                <option value="m/kJ">m/kJ</option>
                                <option value="J/m">J/m</option>
                            </select>
                        </div>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="ev-efficiency" min="1" max="10" step="0.1" value="4">
                    </div>
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span class="label-text">Electricity Cost</span>
                        <div class="value-container">
                            <input type="number" class="value-display" id="ev-cost-display" value="55.0" step="0.1" min="0.1">
                            <select id="ev-cost-unit" class="unit-select">
                                <option value="p/kWh">p/kWh</option>
                                <option value="Â¢/kWh">Â¢/kWh</option>
                                <option value="c/kWh">c/kWh</option>
                                <option value="p/Wh">p/Wh</option>
                                <option value="Â¢/Wh">Â¢/Wh</option>
                                <option value="c/Wh">c/Wh</option>
                                <option value="p/MJ">p/MJ</option>
                                <option value="Â¢/MJ">Â¢/MJ</option>
                                <option value="c/MJ">c/MJ</option>
                            </select>
                        </div>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="ev-cost" min="0" max="150" step="0.1" value="55">
                    </div>
                </div>

                <div class="option-group">
                    <label class="option-label">
                        <input type="checkbox" id="charging-losses-checkbox">
                        <span>Include charging losses</span>
                    </label>
                    <input type="number" id="charging-losses-input" class="efficiency-input" value="10" min="0" max="50" step="0.1" disabled>
                    <span>%</span>
                </div>
            </div>

            <button id="mode-toggle" class="mode-toggle-btn">
                <span id="mode-toggle-text">Unlock & Compare</span>
            </button>

            <div class="section petrol-section">
                <h2 class="section-title">
                    <span class="icon">â›½</span>
                    Internal Combustion
                </h2>
                
                <div class="slider-group">
                    <div class="slider-label">
                        <span class="label-text">Efficiency</span>
                        <div class="value-container">
                            <input type="number" class="value-display" id="petrol-efficiency-display" value="44.0" step="0.1" min="0.1">
                            <select id="fuel-efficiency-unit" class="unit-select">
                                <option value="mpgUK">mpg (UK)</option>
                                <option value="mpgUS">mpg (US)</option>
                                <option value="km/L">km/L</option>
                                <option value="L/100km">L/100km</option>
                            </select>
                        </div>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="petrol-efficiency" min="1" max="200" step="0.1" value="44">
                    </div>
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span class="label-text">Fuel Cost</span>
                        <div class="value-container">
                            <input type="number" class="value-display" id="petrol-cost-display" value="133.9" step="0.1" min="0.1">
                            <span id="fuel-cost-unit-display" class="unit-label">p per</span>
                            <select id="fuel-cost-unit" class="unit-select">
                                <option value="L">litre</option>
                                <option value="galUS">US gallon</option>
                                <option value="galUK">UK gallon</option>
                            </select>
                        </div>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="petrol-cost" min="0" max="200" step="0.1" value="133.9">
                    </div>
                </div>
            </div>
        </div>



        <div class="equivalence-display" id="equivalence-display">
            Cost per mile: 0.00p
        </div>

        <div class="usage-calculator">
            <h3 class="usage-title">Usage Cost Calculator</h3>
            <div class="usage-inputs">
                <div class="slider-group">
                    <div class="slider-label">
                        <span class="label-text">I drive</span>
                        <div class="value-container">
                            <input type="number" class="value-display" id="usage-distance-display" value="150" step="1" min="1">
                            <span id="usage-distance-unit" class="unit-label">miles</span>
                            <span class="usage-label">per</span>
                            <select id="usage-period" class="usage-select">
                                <option value="day">day</option>
                                <option value="week" selected>week</option>
                                <option value="month">month</option>
                                <option value="year">year</option>
                            </select>
                        </div>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="usage-distance" value="150">
                    </div>
                </div>
                <div class="usage-output-group">
                    <span class="usage-label">Show costs per:</span>
                    <select id="output-period" class="usage-select">
                        <option value="day">day</option>
                        <option value="week">week</option>
                        <option value="month" selected>month</option>
                        <option value="year">year</option>
                    </select>
                </div>
            </div>
            <div class="usage-results" id="usage-results">
                <div class="usage-cost-display">
                    <span class="usage-cost-value" id="usage-cost-value">Â£32.50 per month</span>
                </div>
            </div>
        </div>

        <div class="copyright">
            Â© 2025 Peter Harding
        </div>
    </div>

    <script>
        // Constants - using exact definitions where possible
        const LITRES_PER_UK_GALLON = 4.54609; // Exact definition
        const LITRES_PER_US_GALLON = 3.785411784; // Exact definition
        const KM_PER_MILE = 1.609344; // Exact definition (international mile)
        const MILES_PER_KM = 1 / 1.609344; // Computed from exact mile definition
        
        // State
        let state = {
            mode: 'equivalence', // 'equivalence' or 'comparison'
            evEfficiency: 4.0,
            evCost: 55.0,
            petrolEfficiency: 44.0,
            petrolCost: 133.9,
            chargingLosses: 10,
            includeChargingLosses: false,
            evEfficiencyUnit: 'mi/kWh',
            fuelEfficiencyUnit: 'mpgUK',
            fuelCostUnit: 'L',
            evCostUnit: 'p/kWh',
            usageDistance: 150,
            usagePeriod: 'week',
            outputPeriod: 'month',
            usageAnnualDistance: 7821.43 // Store the canonical annual distance
        };

        // Track when each parameter was last modified for virtual locking
        let lastModified = {
            evEfficiency: Date.now(),
            evCost: Date.now() - 1000,
            petrolEfficiency: Date.now() - 2000,
            petrolCost: Date.now() - 3000
        };

        let isUpdating = false; // Prevent circular updates
        let updateQueue = []; // Queue for delayed updates to prevent race conditions

        // Function to update last modified timestamp for a parameter
        function updateLastModified(parameter) {
            lastModified[parameter] = Date.now();
        }

        // Debounced update function to prevent race conditions
        function scheduleUpdate(callback, delay = 10) {
            updateQueue.push(callback);
            
            // Only start the update cycle if it's not already running
            if (updateQueue.length === 1) {
                setTimeout(() => {
                    if (isUpdating) return; // Skip if already updating
                    
                    // Process all queued updates
                    const updates = [...updateQueue];
                    updateQueue.length = 0; // Clear queue
                    
                    isUpdating = true;
                    try {
                        updates.forEach(update => update());
                    } finally {
                        isUpdating = false;
                    }
                }, delay);
            }
        }

        // Get appropriate minimum value for EV efficiency unit
        function getEvEfficiencyMinimum(unit) {
            switch(unit) {
                case 'mi/kWh': return 0.5;
                case 'km/kWh': return 0.8;
                case 'kWh/100mi': return 12.5;
                case 'kWh/100km': return 7.8;
                case 'Wh/mi': return 125;
                case 'Wh/km': return 78;
                case 'm/kJ': return 0.3;
                case 'J/m': return 278;
                default: return 0.1;
            }
        }

        // Get appropriate maximum value for EV efficiency unit
        function getEvEfficiencyMaximum(unit) {
            switch(unit) {
                case 'mi/kWh': return 12;
                case 'km/kWh': return 19.3;
                case 'kWh/100mi': return 200;
                case 'kWh/100km': return 124;
                case 'Wh/mi': return 2000;
                case 'Wh/km': return 1243;
                case 'm/kJ': return 5.4;
                case 'J/m': return 3333;
                default: return 2000;
            }
        }

        // Clamp value to appropriate range for unit
        function clampEvEfficiency(value, unit) {
            const min = getEvEfficiencyMinimum(unit);
            const max = getEvEfficiencyMaximum(unit);
            return Math.max(min, Math.min(max, value));
        }

        // Get appropriate decimal places for unit display
        function getEvEfficiencyPrecision(unit) {
            switch(unit) {
                case 'm/kJ': return 3; // Small values need more precision
                case 'J/m': return 0; // Large values don't need decimals
                case 'Wh/mi':
                case 'Wh/km': return 0; // Whole numbers for Wh
                case 'kWh/100mi':
                case 'kWh/100km': return 1; // One decimal for consumption units
                default: return 1; // Default one decimal
            }
        }



        // Elements
        const elements = {
            evEfficiency: document.getElementById('ev-efficiency'),
            evCost: document.getElementById('ev-cost'),
            petrolEfficiency: document.getElementById('petrol-efficiency'),
            petrolCost: document.getElementById('petrol-cost'),
            evEfficiencyDisplay: document.getElementById('ev-efficiency-display'),
            evCostDisplay: document.getElementById('ev-cost-display'),
            petrolEfficiencyDisplay: document.getElementById('petrol-efficiency-display'),
            petrolCostDisplay: document.getElementById('petrol-cost-display'),
            evCostUnit: document.getElementById('ev-cost-unit'),
            chargingLossesCheckbox: document.getElementById('charging-losses-checkbox'),
            chargingLossesInput: document.getElementById('charging-losses-input'),
            equivalenceDisplay: document.getElementById('equivalence-display'),
            evEfficiencyUnit: document.getElementById('ev-efficiency-unit'),
            fuelEfficiencyUnit: document.getElementById('fuel-efficiency-unit'),
            fuelCostUnit: document.getElementById('fuel-cost-unit'),
            fuelCostUnitDisplay: document.getElementById('fuel-cost-unit-display'),
            usageDistance: document.getElementById('usage-distance'),
            usageDistanceDisplay: document.getElementById('usage-distance-display'),
            usagePeriod: document.getElementById('usage-period'),
            outputPeriod: document.getElementById('output-period'),
            usageDistanceUnit: document.getElementById('usage-distance-unit'),
            usageCostValue: document.getElementById('usage-cost-value'),
            modeToggle: document.getElementById('mode-toggle'),
            modeToggleText: document.getElementById('mode-toggle-text')
        };

        // Unit conversion functions
        function convertEvEfficiency(value, fromUnit, toUnit, allowExtreme = false) {
            // Input validation with bounds checking
            if (isNaN(value) || value === null || value === undefined || value <= 0) {
                return getEvEfficiencyMinimum(toUnit); // Return unit-appropriate default
            }
            
            // Only clamp to reasonable bounds for user inputs, not equivalence calculations
            if (!allowExtreme) {
                const inputMin = getEvEfficiencyMinimum(fromUnit);
                const inputMax = getEvEfficiencyMaximum(fromUnit);
                value = Math.max(inputMin, Math.min(inputMax, value));
            }
            
            if (fromUnit === toUnit) return value;
            
            // Constants for joule conversions
            const J_PER_KWH = 3600000; // 1 kWh = 3.6 MJ = 3,600,000 J
            
            // First convert to a standard unit (mi/kWh)
            let miPerKwh = value;
            
            // From conversions to mi/kWh
            if (fromUnit === 'km/kWh') {
                miPerKwh = value * MILES_PER_KM;
            } else if (fromUnit === 'kWh/100mi') {
                miPerKwh = value > 0 ? 100 / value : getEvEfficiencyMinimum('mi/kWh');
            } else if (fromUnit === 'kWh/100km') {
                miPerKwh = value > 0 ? (100 / KM_PER_MILE) / value : getEvEfficiencyMinimum('mi/kWh');
            } else if (fromUnit === 'Wh/mi') {
                miPerKwh = value > 0 ? 1000 / value : getEvEfficiencyMinimum('mi/kWh');
            } else if (fromUnit === 'Wh/km') {
                // Wh/km to mi/kWh: (Wh/km) â†’ (kWh/km) â†’ (kWh/mi) â†’ (mi/kWh)
                // (Wh/km) * (kWh/1000Wh) * (km/mi) = kWh/mi, then invert
                const kWhPerMile = (value / 1000) * KM_PER_MILE;
                miPerKwh = value > 0 ? (1 / kWhPerMile) : getEvEfficiencyMinimum('mi/kWh');
            } else if (fromUnit === 'm/kJ') {
                // m/kJ to mi/kWh: (m/kJ) * (mi/m) * (kJ/kWh) = mi/kWh
                // 1 mile = 1609.344 m, 1 kWh = 3600 kJ
                const metersPerMile = KM_PER_MILE * 1000;
                const kJPerKwh = J_PER_KWH / 1000;
                miPerKwh = value * (1 / metersPerMile) * kJPerKwh;
            } else if (fromUnit === 'J/m') {
                // J/m to mi/kWh: (J/m) â†’ (kWh/m) â†’ (kWh/mi) â†’ (mi/kWh)
                // (J/m) * (kWh/J) * (m/mi) = kWh/mi, then invert for mi/kWh
                const metersPerMile = KM_PER_MILE * 1000;
                const kWhPerMile = value * (1 / J_PER_KWH) * metersPerMile;
                miPerKwh = value > 0 ? (1 / kWhPerMile) : getEvEfficiencyMinimum('mi/kWh');
            } else if (fromUnit !== 'mi/kWh') {
                miPerKwh = value; // Default fallback for unsupported units
            }
            
            // To conversions from mi/kWh
            if (toUnit === 'mi/kWh') {
                return miPerKwh;
            } else if (toUnit === 'km/kWh') {
                return miPerKwh * KM_PER_MILE;
            } else if (toUnit === 'kWh/100mi') {
                return miPerKwh > 0 ? 100 / miPerKwh : 100;
            } else if (toUnit === 'kWh/100km') {
                return miPerKwh > 0 ? 100 / (miPerKwh * KM_PER_MILE) : 100 / KM_PER_MILE;
            } else if (toUnit === 'Wh/mi') {
                return miPerKwh > 0 ? 1000 / miPerKwh : 1000;
            } else if (toUnit === 'Wh/km') {
                // mi/kWh to Wh/km: (mi/kWh) â†’ (kWh/mi) â†’ (kWh/km) â†’ (Wh/km)
                // (1/mi/kWh) / (km/mi) * (1000Wh/kWh) = Wh/km
                return miPerKwh > 0 ? (1 / miPerKwh) / KM_PER_MILE * 1000 : 1000 / KM_PER_MILE;
            } else if (toUnit === 'm/kJ') {
                // mi/kWh to m/kJ: (mi/kWh) * (m/mi) * (kWh/kJ) = m/kJ
                const metersPerMile = KM_PER_MILE * 1000;
                const kJPerKwh = J_PER_KWH / 1000;
                return miPerKwh * metersPerMile / kJPerKwh;
            } else if (toUnit === 'J/m') {
                // mi/kWh to J/m: (mi/kWh) â†’ (kWh/mi) â†’ (J/mi) â†’ (J/m)
                const metersPerMile = KM_PER_MILE * 1000;
                return miPerKwh > 0 ? (1 / miPerKwh) * J_PER_KWH / metersPerMile : J_PER_KWH / metersPerMile;
            }
            
            return miPerKwh;
        }

        function convertFuelEfficiency(value, fromUnit, toUnit, allowExtreme = false) {
            // Input validation with bounds checking
            if (isNaN(value) || value === null || value === undefined || value <= 0) {
                return 20.0; // Return reasonable default mpgUK
            }
            
            // Only clamp to realistic ranges for user inputs, not equivalence calculations
            if (!allowExtreme) {
                const ranges = {
                    'mpgUK': { min: 5.0, max: 150.0 },
                    'mpgUS': { min: 4.2, max: 125.0 },
                    'km/L': { min: 1.8, max: 53.0 },
                    'L/100km': { min: 1.9, max: 56.6 }
                };
                
                if (ranges[fromUnit]) {
                    value = Math.max(ranges[fromUnit].min, Math.min(ranges[fromUnit].max, value));
                }
            }
            
            if (fromUnit === toUnit) return value;
            
            // First convert to mpgUK
            let mpgUK = value;
            
            if (fromUnit === 'mpgUS') {
                mpgUK = value * (LITRES_PER_UK_GALLON / LITRES_PER_US_GALLON);
            } else if (fromUnit === 'km/L') {
                mpgUK = (value / KM_PER_MILE) * LITRES_PER_UK_GALLON;
            } else if (fromUnit === 'L/100km') {
                // L/100km to mpgUK: (100km in miles) * (UK gallon in litres) / (L per 100km)
                mpgUK = value > 0 ? (100 / KM_PER_MILE) * LITRES_PER_UK_GALLON / value : 0.1;
            }
            
            // Convert from mpgUK to target
            if (toUnit === 'mpgUK') {
                return mpgUK;
            } else if (toUnit === 'mpgUS') {
                return mpgUK * (LITRES_PER_US_GALLON / LITRES_PER_UK_GALLON);
            } else if (toUnit === 'km/L') {
                return (mpgUK * KM_PER_MILE) / LITRES_PER_UK_GALLON;
            } else if (toUnit === 'L/100km') {
                // mpgUK to L/100km: (100km in miles) * (UK gallon in litres) / mpgUK
                return mpgUK > 0 ? (100 / KM_PER_MILE) * LITRES_PER_UK_GALLON / mpgUK : (100 / KM_PER_MILE) * LITRES_PER_UK_GALLON;
            }
            
            return mpgUK;
        }

        function formatEvEfficiency(value, unit) {
            if (unit === 'mi/kWh') {
                return `${value.toFixed(1)} mi/kWh`;
            } else if (unit === 'km/kWh') {
                return `${value.toFixed(1)} km/kWh`;
            } else if (unit === 'kWh/100mi') {
                return `${value.toFixed(1)} kWh/100mi`;
            } else if (unit === 'kWh/100km') {
                return `${value.toFixed(1)} kWh/100km`;
            } else if (unit === 'Wh/mi') {
                return `${value.toFixed(0)} Wh/mi`;
            } else if (unit === 'Wh/km') {
                return `${value.toFixed(0)} Wh/km`;
            } else if (unit === 'm/kJ') {
                return `${value.toFixed(1)} m/kJ`;
            } else if (unit === 'J/m') {
                return `${value.toFixed(0)} J/m`;
            }
            return `${value.toFixed(1)} ${unit}`; // Fallback for unknown units
        }

        function formatFuelEfficiency(value, unit) {
            if (unit === 'mpgUK') {
                return `${value.toFixed(1)} mpg (UK)`;
            } else if (unit === 'mpgUS') {
                return `${value.toFixed(1)} mpg (US)`;
            } else if (unit === 'km/L') {
                return `${value.toFixed(1)} km/L`;
            } else if (unit === 'L/100km') {
                return `${value.toFixed(1)} L/100km`;
            }
            return `${value.toFixed(1)} ${unit}`; // Fallback for unknown units
        }


        function getEvCostCurrencySymbol() {
            if (state.evCostUnit.includes('p/')) return 'p';
            if (state.evCostUnit.includes('Â¢/')) return 'Â¢';
            if (state.evCostUnit.includes('c/')) return 'c';
            return 'p';
        }
        
        function getMainCurrencySymbol() {
            if (state.evCostUnit.includes('p/')) return 'Â£';
            if (state.evCostUnit.includes('Â¢/')) return '$';
            if (state.evCostUnit.includes('c/')) return 'â‚¬';
            return 'Â£';
        }
        
        function getFuelVolumeUnit() {
            return state.fuelCostUnit; // Now directly returns 'L', 'galUK', or 'galUS'
        }
        
        function convertEvCost(value, fromUnit, toUnit, allowExtreme = false) {
            // Input validation with bounds checking
            if (isNaN(value) || value === null || value === undefined || value < 0) {
                return 30.0; // Return reasonable default p/kWh
            }
            
            // Only clamp to realistic cost ranges for user inputs, not equivalence calculations
            if (!allowExtreme) {
                const maxCosts = {
                    'p/kWh': 120.0, 'Â¢/kWh': 120.0, 'c/kWh': 120.0,
                    'p/Wh': 0.35, 'Â¢/Wh': 0.35, 'c/Wh': 0.35,
                    'p/MJ': 90.0, 'Â¢/MJ': 90.0, 'c/MJ': 90.0
                };
                
                if (maxCosts[fromUnit]) {
                    value = Math.max(0, Math.min(maxCosts[fromUnit], value));
                }
            }
            
            if (fromUnit === toUnit) return value;
            
            // Constants
            const MJ_PER_KWH = 3.6; // 1 kWh = 3.6 MJ
            
            // Convert to standard unit (p/kWh) first
            let pPerKwh = value;
            
            // IMPORTANT: Currency conversions assume 1:1 equivalence for comparison purposes
            // This does NOT reflect real exchange rates (1p â‰  1Â¢ â‰  1c in reality)
            // The calculator focuses on relative cost comparisons within the same currency system
            
            // From conversions to p/kWh
            if (fromUnit === 'Â¢/kWh') {
                pPerKwh = value; // 1:1 conversion for display consistency
            } else if (fromUnit === 'c/kWh') {
                pPerKwh = value; // 1:1 conversion for display consistency
            } else if (fromUnit === 'p/Wh') {
                pPerKwh = value * 1000; // 1000 Wh = 1 kWh
            } else if (fromUnit === 'Â¢/Wh') {
                pPerKwh = value * 1000;
            } else if (fromUnit === 'c/Wh') {
                pPerKwh = value * 1000;
            } else if (fromUnit === 'p/MJ') {
                pPerKwh = value * MJ_PER_KWH; // Convert MJ to kWh
            } else if (fromUnit === 'Â¢/MJ') {
                pPerKwh = value * MJ_PER_KWH;
            } else if (fromUnit === 'c/MJ') {
                pPerKwh = value * MJ_PER_KWH;
            }
            
            // To conversions from p/kWh
            if (toUnit === 'p/kWh') {
                return pPerKwh;
            } else if (toUnit === 'Â¢/kWh') {
                return pPerKwh; // 1:1 conversion for display consistency
            } else if (toUnit === 'c/kWh') {
                return pPerKwh; // 1:1 conversion for display consistency
            } else if (toUnit === 'p/Wh') {
                return pPerKwh / 1000;
            } else if (toUnit === 'Â¢/Wh') {
                return pPerKwh / 1000;
            } else if (toUnit === 'c/Wh') {
                return pPerKwh / 1000;
            } else if (toUnit === 'p/MJ') {
                return pPerKwh / MJ_PER_KWH; // Convert kWh to MJ
            } else if (toUnit === 'Â¢/MJ') {
                return pPerKwh / MJ_PER_KWH;
            } else if (toUnit === 'c/MJ') {
                return pPerKwh / MJ_PER_KWH;
            }
            
            return pPerKwh;
        }
        

        // Calculate cost per mile for EV
        function calculateEvCostPerMile() {
            let efficiency = convertEvEfficiency(state.evEfficiency, state.evEfficiencyUnit, 'mi/kWh', true); // Allow extreme values
            
            // Convert EV cost to p/kWh for calculation
            let costInPPerKwh = convertEvCost(state.evCost, state.evCostUnit, 'p/kWh', true); // Allow extreme values
            let costPerKwh = costInPPerKwh / 100; // Convert to base unit
            
            let costPerMile = costPerKwh / efficiency;
            
            if (state.includeChargingLosses) {
                costPerMile *= (1 + state.chargingLosses / 100);
            }
            
            return costPerMile;
        }

        // Calculate cost per mile for petrol
        function calculatePetrolCostPerMile() {
            let efficiency = convertFuelEfficiency(state.petrolEfficiency, state.fuelEfficiencyUnit, 'mpgUK', true); // Allow extreme values
            let costPerUnit = state.petrolCost / 100; // Convert currency to base unit
            
            // Convert cost to per litre if needed
            const volumeUnit = getFuelVolumeUnit();
            let costPerLitre;
            if (volumeUnit === 'galUK') {
                costPerLitre = costPerUnit / LITRES_PER_UK_GALLON;
            } else if (volumeUnit === 'galUS') {
                costPerLitre = costPerUnit / LITRES_PER_US_GALLON;
            } else {
                costPerLitre = costPerUnit; // Already per litre
            }
            
            let costPerGallon = costPerLitre * LITRES_PER_UK_GALLON;
            return costPerGallon / efficiency;
        }

        // Usage calculation functions
        // Standardized time period constants
        const DAYS_PER_YEAR = 365.25; // Including leap years
        const WEEKS_PER_YEAR = DAYS_PER_YEAR / 7; // 52.1786
        const MONTHS_PER_YEAR = 12;
        const DAYS_PER_MONTH = DAYS_PER_YEAR / MONTHS_PER_YEAR; // 30.4375

        function convertUsageToDaily(distance, period) {
            switch(period) {
                case 'day': return distance;
                case 'week': return distance / 7;
                case 'month': return distance / DAYS_PER_MONTH;
                case 'year': return distance / DAYS_PER_YEAR;
                default: return distance;
            }
        }

        function convertDailyToOutputPeriod(dailyDistance, outputPeriod) {
            switch(outputPeriod) {
                case 'day': return dailyDistance;
                case 'week': return dailyDistance * 7;
                case 'month': return dailyDistance * DAYS_PER_MONTH;
                case 'year': return dailyDistance * DAYS_PER_YEAR;
                default: return dailyDistance;
            }
        }

        function convertUsageToAnnual(distance, period) {
            switch(period) {
                case 'day': return distance * DAYS_PER_YEAR;
                case 'week': return distance * WEEKS_PER_YEAR;
                case 'month': return distance * MONTHS_PER_YEAR;
                case 'year': return distance;
                default: return distance;
            }
        }

        function convertAnnualToUsagePeriod(annualDistance, period) {
            switch(period) {
                case 'day': return annualDistance / DAYS_PER_YEAR;
                case 'week': return annualDistance / WEEKS_PER_YEAR;
                case 'month': return annualDistance / MONTHS_PER_YEAR;
                case 'year': return annualDistance;
                default: return annualDistance;
            }
        }

        function getCurrentPeriodDistance() {
            return convertAnnualToUsagePeriod(state.usageAnnualDistance, state.usagePeriod);
        }

        function updateUsageSliderRange() {
            // Define annual mileage range (0 to 20,000 miles/year)
            const minAnnual = 0;
            const maxAnnual = 20000;
            
            // Convert to current period with precise calculation
            const minForPeriod = convertAnnualToUsagePeriod(minAnnual, state.usagePeriod);
            const maxForPeriod = convertAnnualToUsagePeriod(maxAnnual, state.usagePeriod);
            
            // Update slider range with proper rounding
            elements.usageDistance.min = Math.floor(minForPeriod);
            elements.usageDistance.max = Math.ceil(maxForPeriod);
            
            // Set appropriate step size based on period
            const stepSizes = {
                'day': 1,
                'week': 5,
                'month': 10,
                'year': 50
            };
            elements.usageDistance.step = stepSizes[state.usagePeriod] || 1;
            
            // Update the current distance for display with precision preservation
            const currentDistance = getCurrentPeriodDistance();
            // Use appropriate rounding based on period
            if (state.usagePeriod === 'day') {
                state.usageDistance = Math.round(currentDistance);
            } else if (state.usagePeriod === 'week') {
                state.usageDistance = Math.round(currentDistance / 5) * 5; // Round to nearest 5
            } else if (state.usagePeriod === 'month') {
                state.usageDistance = Math.round(currentDistance / 10) * 10; // Round to nearest 10
            } else { // year
                state.usageDistance = Math.round(currentDistance / 50) * 50; // Round to nearest 50
            }
        }

        function calculateUsageCosts() {
            // Convert input distance to daily distance
            const dailyDistance = convertUsageToDaily(state.usageDistance, state.usagePeriod);
            
            // Convert to output period distance
            const outputDistance = convertDailyToOutputPeriod(dailyDistance, state.outputPeriod);
            
            // Get cost per mile (functions always return cost per mile)
            const evCostPerMile = calculateEvCostPerMile();
            const petrolCostPerMile = calculatePetrolCostPerMile();
            
            // Check if we need to convert to cost per km
            const isMetric = state.evEfficiencyUnit.includes('km') || 
                           state.evEfficiencyUnit.includes('J/m') || 
                           state.evEfficiencyUnit.includes('m/kJ');
            let evCostPerUnit = evCostPerMile;
            let petrolCostPerUnit = petrolCostPerMile;
            
            if (isMetric) {
                // Convert from cost per mile to cost per km
                evCostPerUnit = evCostPerMile / KM_PER_MILE;
                petrolCostPerUnit = petrolCostPerMile / KM_PER_MILE;
            }
            
            // Calculate total costs for the output period
            const evTotalCost = evCostPerUnit * outputDistance;
            const petrolTotalCost = petrolCostPerUnit * outputDistance;
            const savings = petrolTotalCost - evTotalCost;
            
            return {
                evCost: evTotalCost,
                petrolCost: petrolTotalCost,
                savings: savings,
                outputDistance: outputDistance
            };
        }

        function updateUsageDisplay() {
            // Update distance unit based on EV efficiency unit
            const isMetric = state.evEfficiencyUnit.includes('km') || 
                           state.evEfficiencyUnit.includes('J/m') || 
                           state.evEfficiencyUnit.includes('m/kJ');
            const distanceUnit = isMetric ? 'km' : 'miles';
            elements.usageDistanceUnit.textContent = distanceUnit;
            
            // Calculate costs
            const costs = calculateUsageCosts();
            const currency = getMainCurrencySymbol();
            const periodText = state.outputPeriod;
            
            if (state.mode === 'equivalence') {
                // Hide the entire usage results container in the grey box
                const usageResults = document.querySelector('.usage-results');
                if (usageResults) {
                    usageResults.style.display = 'none';
                }
                
                // Show single cost in separate container (like per-distance)
                const usageSavingsContainer = document.getElementById('usage-savings-container') || createUsageSavingsContainer();
                const cost = `${currency}${costs.evCost.toFixed(2)}`;
                
                usageSavingsContainer.className = 'equivalence-display';
                usageSavingsContainer.innerHTML = `Cost per ${periodText}: ${cost}`;
                usageSavingsContainer.style.display = 'block';
                
                // Hide savings-only container in equivalence mode
                const savingsOnlyContainer = document.getElementById('usage-savings-only-container');
                if (savingsOnlyContainer) {
                    savingsOnlyContainer.style.display = 'none';
                }
            } else {
                // Hide the usage results container in comparison mode too
                const usageResults = document.querySelector('.usage-results');
                if (usageResults) {
                    usageResults.style.display = 'none';
                }
                
                // Show split costs in separate container (outside grey box)
                const evCost = `${currency}${costs.evCost.toFixed(2)}`;
                const petrolCost = `${currency}${costs.petrolCost.toFixed(2)}`;
                const savings = costs.savings;
                
                const usageSavingsContainer = document.getElementById('usage-savings-container') || createUsageSavingsContainer();
                
                // Show split cost display outside the grey box
                usageSavingsContainer.className = 'equivalence-display';
                usageSavingsContainer.innerHTML = `
                    <div class="cost-split">
                        <div class="cost-ev">
                            EV: ${evCost}<br>
                            <small>per ${periodText}</small>
                        </div>
                        <div class="cost-separator">vs</div>
                        <div class="cost-ice">
                            ICE: ${petrolCost}<br>
                            <small>per ${periodText}</small>
                        </div>
                    </div>
                `;
                usageSavingsContainer.style.display = 'block';
                
                // Add separate savings display if there's a difference
                if (Math.abs(savings) > 0.01) {
                    const isEvCheaper = savings > 0;
                    const savingsAmount = Math.abs(savings).toFixed(2);
                    
                    // Create a second container for savings
                    let savingsOnlyContainer = document.getElementById('usage-savings-only-container');
                    if (!savingsOnlyContainer) {
                        savingsOnlyContainer = document.createElement('div');
                        savingsOnlyContainer.id = 'usage-savings-only-container';
                        usageSavingsContainer.parentNode.insertBefore(savingsOnlyContainer, usageSavingsContainer.nextSibling);
                    }
                    
                    savingsOnlyContainer.className = isEvCheaper ? 'savings-display' : 'savings-display ice-cheaper';
                    savingsOnlyContainer.innerHTML = isEvCheaper 
                        ? `EVs save ${currency}${savingsAmount} per ${periodText} compared to ICE vehicles`
                        : `EVs cost ${currency}${savingsAmount} more per ${periodText} than ICE vehicles`;
                    savingsOnlyContainer.style.display = 'block';
                } else {
                    // Hide savings-only container when costs are identical
                    const savingsOnlyContainer = document.getElementById('usage-savings-only-container');
                    if (savingsOnlyContainer) {
                        savingsOnlyContainer.style.display = 'none';
                    }
                }
            }
        }

        // Create usage savings container if it doesn't exist
        function createUsageSavingsContainer() {
            let container = document.getElementById('usage-savings-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'usage-savings-container';
                container.className = 'savings-display';
                // Insert after the entire usage calculator container, not inside it
                const usageCalculator = document.querySelector('.usage-calculator');
                usageCalculator.parentNode.insertBefore(container, usageCalculator.nextSibling);
            }
            return container;
        }

        // Toggle between equivalence and comparison modes
        function toggleMode() {
            state.mode = state.mode === 'equivalence' ? 'comparison' : 'equivalence';
            
            // Update button appearance and text
            if (state.mode === 'comparison') {
                elements.modeToggle.classList.add('comparison-mode');
                elements.modeToggleText.textContent = 'Lock to Equivalence';
            } else {
                elements.modeToggle.classList.remove('comparison-mode');
                elements.modeToggleText.textContent = 'Unlock & Compare';
            }
            
            // Update displays
            updateDisplays();
        }

        // Update displays with better race condition handling
        function updateDisplays() {
            // Use the scheduled update system for better race condition handling
            scheduleUpdate(() => {
                // Only update input values if they're not currently focused (being edited)
                if (document.activeElement !== elements.evEfficiencyDisplay) {
                    const precision = getEvEfficiencyPrecision(state.evEfficiencyUnit);
                    elements.evEfficiencyDisplay.value = state.evEfficiency.toFixed(precision);
                }
                if (document.activeElement !== elements.evCostDisplay) {
                    elements.evCostDisplay.value = state.evCost.toFixed(1);
                }
                if (document.activeElement !== elements.petrolEfficiencyDisplay) {
                    elements.petrolEfficiencyDisplay.value = state.petrolEfficiency.toFixed(1);
                }
                if (document.activeElement !== elements.petrolCostDisplay) {
                    elements.petrolCostDisplay.value = state.petrolCost.toFixed(1);
                }
                if (document.activeElement !== elements.usageDistanceDisplay) {
                    elements.usageDistanceDisplay.value = state.usageDistance.toString();
                }
                
                // Update sliders to match state
                elements.evEfficiency.value = state.evEfficiency;
                elements.evCost.value = state.evCost;
                elements.petrolEfficiency.value = state.petrolEfficiency;
                elements.petrolCost.value = state.petrolCost;
                elements.usageDistance.value = state.usageDistance;
                
                // Update fuel cost unit display text with currency
                const volumeUnit = state.fuelCostUnit;
                const currency = getEvCostCurrencySymbol(); // Use same currency as EV costs
                elements.fuelCostUnitDisplay.textContent = `${currency} per`;
                elements.fuelCostUnit.value = volumeUnit;
                
                // Update main cost display based on mode
                updateCostDisplay();
                
                // Update usage calculator display
                updateUsageDisplay();
            });
        }

        // Update cost display based on current mode
        function updateCostDisplay() {
            const evCostPerMile = calculateEvCostPerMile();
            const petrolCostPerMile = calculatePetrolCostPerMile();
            const currency = getEvCostCurrencySymbol();
            
            // Determine distance unit from EV efficiency unit
            const isMetric = state.evEfficiencyUnit.includes('km') || 
                           state.evEfficiencyUnit.includes('J/m') || 
                           state.evEfficiencyUnit.includes('m/kJ');
            
            const distanceUnit = isMetric ? 'km' : 'mile';
            const evCostPerUnit = isMetric ? evCostPerMile * MILES_PER_KM : evCostPerMile;
            const petrolCostPerUnit = isMetric ? petrolCostPerMile * MILES_PER_KM : petrolCostPerMile;
            
            if (state.mode === 'equivalence') {
                // Show single unified cost
                elements.equivalenceDisplay.innerHTML = `Cost per ${distanceUnit}: ${(evCostPerUnit * 100).toFixed(2)}${currency}`;
                
                // Hide savings container in equivalence mode
                const savingsContainer = document.getElementById('savings-container');
                if (savingsContainer) {
                    savingsContainer.style.display = 'none';
                }
            } else {
                // Show split comparison
                const evCost = (evCostPerUnit * 100).toFixed(2);
                const petrolCost = (petrolCostPerUnit * 100).toFixed(2);
                
                elements.equivalenceDisplay.innerHTML = `
                    <div class="cost-split">
                        <div class="cost-ev">
                            EV: ${evCost}${currency}<br>
                            <small>per ${distanceUnit}</small>
                        </div>
                        <div class="cost-separator">vs</div>
                        <div class="cost-ice">
                            ICE: ${petrolCost}${currency}<br>
                            <small>per ${distanceUnit}</small>
                        </div>
                    </div>
                `;
                
                // Add savings display
                const difference = petrolCostPerUnit - evCostPerUnit;
                const savingsContainer = document.getElementById('savings-container') || createSavingsContainer();
                
                if (Math.abs(difference) > 0.0001) {
                    const isEvCheaper = difference > 0;
                    const savingsAmount = Math.abs(difference * 100).toFixed(2);
                    
                    savingsContainer.className = isEvCheaper ? 'savings-display' : 'savings-display ice-cheaper';
                    savingsContainer.innerHTML = isEvCheaper 
                        ? `EVs save ${savingsAmount}${currency} per ${distanceUnit} compared to ICE vehicles`
                        : `EVs cost ${savingsAmount}${currency} more per ${distanceUnit} than ICE vehicles`;
                    savingsContainer.style.display = 'block';
                } else {
                    // Hide savings container when costs are identical
                    savingsContainer.style.display = 'none';
                }
            }
        }

        // Create savings container if it doesn't exist
        function createSavingsContainer() {
            let container = document.getElementById('savings-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'savings-container';
                container.className = 'savings-display';
                elements.equivalenceDisplay.parentNode.insertBefore(container, elements.equivalenceDisplay.nextSibling);
            }
            return container;
        }

        // Update slider ranges based on units - realistic efficiency values
        function updateSliderRanges() {
            // EV efficiency ranges - expanded for high-efficiency vehicles
            if (state.evEfficiencyUnit === 'mi/kWh') {
                elements.evEfficiency.min = 1.0; // Poor efficiency
                elements.evEfficiency.max = 8.0; // Excellent efficiency (e.g., Lucid Air)
                elements.evEfficiency.step = 0.1;
            } else if (state.evEfficiencyUnit === 'km/kWh') {
                elements.evEfficiency.min = 1.6; // Poor efficiency (1.0 mi/kWh)
                elements.evEfficiency.max = 12.9; // Excellent efficiency (8.0 mi/kWh)
                elements.evEfficiency.step = 0.1;
            } else if (state.evEfficiencyUnit === 'kWh/100mi') {
                elements.evEfficiency.min = 12.5; // Excellent efficiency (8.0 mi/kWh)
                elements.evEfficiency.max = 100.0; // Poor efficiency (1.0 mi/kWh)
                elements.evEfficiency.step = 0.5;
            } else if (state.evEfficiencyUnit === 'kWh/100km') {
                elements.evEfficiency.min = 7.8; // Excellent efficiency (12.9 km/kWh)
                elements.evEfficiency.max = 62.1; // Poor efficiency (1.6 km/kWh)
                elements.evEfficiency.step = 0.5;
            } else if (state.evEfficiencyUnit === 'Wh/mi') {
                elements.evEfficiency.min = 125; // Excellent efficiency (8.0 mi/kWh)
                elements.evEfficiency.max = 1000; // Poor efficiency (1.0 mi/kWh)
                elements.evEfficiency.step = 10;
            } else if (state.evEfficiencyUnit === 'Wh/km') {
                elements.evEfficiency.min = 78; // Excellent efficiency (12.9 km/kWh)
                elements.evEfficiency.max = 621; // Poor efficiency (1.6 km/kWh)
                elements.evEfficiency.step = 5;
            } else if (state.evEfficiencyUnit === 'm/kJ') {
                elements.evEfficiency.min = 0.45; // Poor efficiency
                elements.evEfficiency.max = 3.6; // Excellent efficiency
                elements.evEfficiency.step = 0.01;
            } else if (state.evEfficiencyUnit === 'J/m') {
                elements.evEfficiency.min = 278; // Excellent efficiency
                elements.evEfficiency.max = 2222; // Poor efficiency
                elements.evEfficiency.step = 10;
            }
            
            // Fuel efficiency ranges - expanded for high-efficiency vehicles including hybrids
            if (state.fuelEfficiencyUnit === 'mpgUK') {
                elements.petrolEfficiency.min = 10.0; // Poor fuel economy
                elements.petrolEfficiency.max = 120.0; // Excellent fuel economy (e.g., Toyota Prius, some hybrids)
                elements.petrolEfficiency.step = 0.5;
            } else if (state.fuelEfficiencyUnit === 'mpgUS') {
                elements.petrolEfficiency.min = 8.3; // Poor fuel economy
                elements.petrolEfficiency.max = 100.0; // Excellent fuel economy (hybrids)
                elements.petrolEfficiency.step = 0.5;
            } else if (state.fuelEfficiencyUnit === 'km/L') {
                elements.petrolEfficiency.min = 3.5; // Poor fuel economy
                elements.petrolEfficiency.max = 42.3; // Excellent fuel economy (120 mpgUK)
                elements.petrolEfficiency.step = 0.1;
            } else if (state.fuelEfficiencyUnit === 'L/100km') {
                elements.petrolEfficiency.min = 2.4; // Excellent fuel economy (42.3 km/L)
                elements.petrolEfficiency.max = 28.6; // Poor fuel economy (3.5 km/L)
                elements.petrolEfficiency.step = 0.1;
            }
            
            // Energy cost ranges - expanded for diverse pricing scenarios
            if (state.evCostUnit.includes('/Wh')) {
                elements.evCost.min = 0.005;
                elements.evCost.max = 0.30; // Expanded Wh pricing range
                elements.evCost.step = 0.001;
            } else if (state.evCostUnit.includes('/MJ')) {
                elements.evCost.min = 0.5;
                elements.evCost.max = 80.0; // Expanded MJ pricing range
                elements.evCost.step = 0.1;
            } else {
                elements.evCost.min = 2.0; // Very cheap off-peak electricity
                elements.evCost.max = 100.0; // Expensive peak electricity
                elements.evCost.step = 0.1;
            }
            
            // Petrol cost range - expanded for global pricing variations
            elements.petrolCost.min = 50.0; // Very cheap fuel regions
            elements.petrolCost.max = 300.0; // Very expensive fuel regions
            elements.petrolCost.step = 0.1;
        }

        // Maintain equivalence using virtual locking based on modification order
        function maintainEquivalence(changedParameter) {
            // Only maintain equivalence in equivalence mode
            if (state.mode !== 'equivalence') return;
            
            // Prevent recursive calls and race conditions
            if (isUpdating) return;
            
            const evCostPerMile = calculateEvCostPerMile();
            const petrolCostPerMile = calculatePetrolCostPerMile();
            
            // Only adjust if costs are significantly different (prevent micro-adjustments)
            const tolerance = 0.0001; // 0.01p difference
            if (Math.abs(evCostPerMile - petrolCostPerMile) < tolerance) {
                return;
            }
            
            // Get all parameters except the one that just changed
            const otherParams = ['evEfficiency', 'evCost', 'petrolEfficiency', 'petrolCost']
                .filter(param => param !== changedParameter);
            
            // Sort by last modified timestamp (oldest first)
            otherParams.sort((a, b) => lastModified[a] - lastModified[b]);
            
            // The oldest modified parameter is the one we'll adjust
            const paramToAdjust = otherParams[0];
            
            // Schedule the adjustment to prevent race conditions
            scheduleUpdate(() => {
                if (paramToAdjust === 'evEfficiency') {
                    adjustEvEfficiency(petrolCostPerMile);
                } else if (paramToAdjust === 'evCost') {
                    adjustEvCost(petrolCostPerMile);
                } else if (paramToAdjust === 'petrolEfficiency') {
                    adjustPetrolEfficiency(evCostPerMile);
                } else if (paramToAdjust === 'petrolCost') {
                    adjustPetrolCost(evCostPerMile);
                }
            });
        }
        
        function adjustPetrolEfficiency(evCostPerMile) {
            const volumeUnit = getFuelVolumeUnit();
            let costPerLitre = state.petrolCost / 100;
            if (volumeUnit === 'galUK') {
                costPerLitre = (state.petrolCost / 100) / LITRES_PER_UK_GALLON;
            } else if (volumeUnit === 'galUS') {
                costPerLitre = (state.petrolCost / 100) / LITRES_PER_US_GALLON;
            }
            
            let targetEfficiency = (costPerLitre * LITRES_PER_UK_GALLON) / evCostPerMile;
            targetEfficiency = convertFuelEfficiency(targetEfficiency, 'mpgUK', state.fuelEfficiencyUnit, true); // Allow extreme values
            // Allow any efficiency value for equivalence - no bounds checking
            state.petrolEfficiency = Math.max(0.1, targetEfficiency); // Only prevent zero/negative
            elements.petrolEfficiency.value = state.petrolEfficiency;
        }
        
        function adjustPetrolCost(evCostPerMile) {
            let mpgUK = convertFuelEfficiency(state.petrolEfficiency, state.fuelEfficiencyUnit, 'mpgUK', true); // Allow extreme values
            let targetCostPerLitre = (evCostPerMile * mpgUK) / LITRES_PER_UK_GALLON;
            
            const volumeUnit = getFuelVolumeUnit();
            let targetCost = targetCostPerLitre * 100; // Convert to currency
            if (volumeUnit === 'galUK') {
                targetCost = targetCostPerLitre * LITRES_PER_UK_GALLON * 100;
            } else if (volumeUnit === 'galUS') {
                targetCost = targetCostPerLitre * LITRES_PER_US_GALLON * 100;
            }
            
            // Allow any cost value for equivalence - no bounds checking
            state.petrolCost = Math.max(0.1, targetCost); // Only prevent zero/negative
            elements.petrolCost.value = state.petrolCost;
        }
        
        function adjustEvEfficiency(petrolCostPerMile) {
            let targetEfficiency = (state.evCost / 100) / petrolCostPerMile;
            
            if (state.includeChargingLosses) {
                targetEfficiency /= (1 + state.chargingLosses / 100);
            }
            targetEfficiency = convertEvEfficiency(targetEfficiency, 'mi/kWh', state.evEfficiencyUnit, true); // Allow extreme values
            // Allow any efficiency value for equivalence - no bounds checking
            const minValue = getEvEfficiencyMinimum(state.evEfficiencyUnit);
            state.evEfficiency = Math.max(minValue, targetEfficiency); // Only prevent impossible values
            elements.evEfficiency.value = state.evEfficiency;
        }
        
        function adjustEvCost(petrolCostPerMile) {
            let targetCostInP = petrolCostPerMile * convertEvEfficiency(state.evEfficiency, state.evEfficiencyUnit, 'mi/kWh', true) * 100; // Allow extreme values
            if (state.includeChargingLosses) {
                targetCostInP *= (1 + state.chargingLosses / 100);
            }
            
            // Convert from p/kWh to current unit
            let targetCost = convertEvCost(targetCostInP, 'p/kWh', state.evCostUnit, true); // Allow extreme values
            
            // Allow any cost value for equivalence - no bounds checking
            state.evCost = Math.max(0.1, targetCost); // Only prevent zero/negative
            elements.evCost.value = state.evCost;
        }

        // Event listeners with improved debouncing
        elements.evEfficiency.addEventListener('input', (e) => {
            if (isUpdating) return;
            const value = parseFloat(e.target.value);
            if (!isNaN(value)) {
                state.evEfficiency = value;
                updateLastModified('evEfficiency');
                maintainEquivalence('evEfficiency');
                updateDisplays();
            }
        });

        elements.evCost.addEventListener('input', (e) => {
            if (isUpdating) return;
            const value = parseFloat(e.target.value);
            if (!isNaN(value)) {
                state.evCost = value;
                updateLastModified('evCost');
                maintainEquivalence('evCost');
                updateDisplays();
            }
        });

        elements.petrolEfficiency.addEventListener('input', (e) => {
            if (isUpdating) return;
            const value = parseFloat(e.target.value);
            if (!isNaN(value)) {
                state.petrolEfficiency = value;
                updateLastModified('petrolEfficiency');
                maintainEquivalence('petrolEfficiency');
                updateDisplays();
            }
        });

        elements.petrolCost.addEventListener('input', (e) => {
            if (isUpdating) return;
            const value = parseFloat(e.target.value);
            if (!isNaN(value)) {
                state.petrolCost = value;
                updateLastModified('petrolCost');
                maintainEquivalence('petrolCost');
                updateDisplays();
            }
        });

        // Value display input event listeners - use blur and change events to avoid jumping values while typing
        elements.evEfficiencyDisplay.addEventListener('blur', (e) => {
            const value = parseFloat(e.target.value);
            if (!isNaN(value) && value > 0) {
                state.evEfficiency = value;
                elements.evEfficiency.value = value;
                updateLastModified('evEfficiency');
                maintainEquivalence('evEfficiency');
                updateDisplays();
            } else {
                // Reset to current state value if invalid
                e.target.value = state.evEfficiency.toFixed(1);
            }
        });

        elements.evCostDisplay.addEventListener('blur', (e) => {
            const value = parseFloat(e.target.value);
            if (!isNaN(value) && value > 0) {
                state.evCost = value;
                elements.evCost.value = value;
                updateLastModified('evCost');
                maintainEquivalence('evCost');
                updateDisplays();
            } else {
                // Reset to current state value if invalid
                e.target.value = state.evCost.toFixed(1);
            }
        });

        elements.petrolEfficiencyDisplay.addEventListener('blur', (e) => {
            const value = parseFloat(e.target.value);
            if (!isNaN(value) && value > 0) {
                state.petrolEfficiency = value;
                elements.petrolEfficiency.value = value;
                updateLastModified('petrolEfficiency');
                maintainEquivalence('petrolEfficiency');
                updateDisplays();
            } else {
                // Reset to current state value if invalid
                e.target.value = state.petrolEfficiency.toFixed(1);
            }
        });

        elements.petrolCostDisplay.addEventListener('blur', (e) => {
            const value = parseFloat(e.target.value);
            if (!isNaN(value) && value > 0) {
                state.petrolCost = value;
                elements.petrolCost.value = value;
                updateLastModified('petrolCost');
                maintainEquivalence('petrolCost');
                updateDisplays();
            } else {
                // Reset to current state value if invalid
                e.target.value = state.petrolCost.toFixed(1);
            }
        });


        // Charging losses
        elements.chargingLossesCheckbox.addEventListener('change', (e) => {
            state.includeChargingLosses = e.target.checked;
            elements.chargingLossesInput.disabled = !e.target.checked;
            maintainEquivalence('chargingLosses');
            updateDisplays();
        });

        elements.chargingLossesInput.addEventListener('input', (e) => {
            state.chargingLosses = parseFloat(e.target.value) || 0;
            maintainEquivalence('chargingLosses');
            updateDisplays();
        });

        // Unit selectors
        elements.evEfficiencyUnit.addEventListener('change', (e) => {
            const oldUnit = state.evEfficiencyUnit;
            const newUnit = e.target.value;
            
            // Convert using mathematical equivalence to maintain cost equivalence
            state.evEfficiency = convertEvEfficiency(state.evEfficiency, oldUnit, newUnit);
            state.evEfficiencyUnit = newUnit;
            
            // Auto-update fuel efficiency to match distance base
            const isMetric = newUnit.includes('km') || 
                           newUnit.includes('J/m') || 
                           newUnit.includes('m/kJ');
            const currentFuelIsMetric = state.fuelEfficiencyUnit.includes('km') || state.fuelEfficiencyUnit.includes('L');
            
            if (isMetric && !currentFuelIsMetric) {
                // Switch to metric fuel units
                const oldFuelEfficiency = state.petrolEfficiency;
                if (state.fuelEfficiencyUnit === 'mpgUK') {
                    state.petrolEfficiency = convertFuelEfficiency(oldFuelEfficiency, 'mpgUK', 'L/100km');
                    state.fuelEfficiencyUnit = 'L/100km';
                } else if (state.fuelEfficiencyUnit === 'mpgUS') {
                    state.petrolEfficiency = convertFuelEfficiency(oldFuelEfficiency, 'mpgUS', 'L/100km');
                    state.fuelEfficiencyUnit = 'L/100km';
                }
                elements.fuelEfficiencyUnit.value = state.fuelEfficiencyUnit;
                elements.petrolEfficiency.value = state.petrolEfficiency;
                elements.petrolEfficiencyDisplay.value = state.petrolEfficiency.toFixed(1);
            } else if (!isMetric && currentFuelIsMetric) {
                // Switch to imperial fuel units
                const oldFuelEfficiency = state.petrolEfficiency;
                if (state.fuelEfficiencyUnit === 'L/100km') {
                    state.petrolEfficiency = convertFuelEfficiency(oldFuelEfficiency, 'L/100km', 'mpgUK');
                    state.fuelEfficiencyUnit = 'mpgUK';
                } else if (state.fuelEfficiencyUnit === 'km/L') {
                    state.petrolEfficiency = convertFuelEfficiency(oldFuelEfficiency, 'km/L', 'mpgUK');
                    state.fuelEfficiencyUnit = 'mpgUK';
                }
                elements.fuelEfficiencyUnit.value = state.fuelEfficiencyUnit;
                elements.petrolEfficiency.value = state.petrolEfficiency;
                elements.petrolEfficiencyDisplay.value = state.petrolEfficiency.toFixed(1);
            }
            
            updateSliderRanges();
            elements.evEfficiency.value = state.evEfficiency;
            updateDisplays();
        });

        elements.fuelEfficiencyUnit.addEventListener('change', (e) => {
            const oldUnit = state.fuelEfficiencyUnit;
            const newUnit = e.target.value;
            
            // Convert the current value to the new unit
            state.petrolEfficiency = convertFuelEfficiency(state.petrolEfficiency, oldUnit, newUnit);
            state.fuelEfficiencyUnit = newUnit;
            
            updateSliderRanges();
            elements.petrolEfficiency.value = state.petrolEfficiency;
            updateDisplays();
        });

        elements.fuelCostUnit.addEventListener('change', (e) => {
            const oldUnit = state.fuelCostUnit;
            const newUnit = e.target.value;
            
            // Convert petrol cost between different volume units
            // Get cost per litre as base unit
            let costPerLitre = state.petrolCost / 100;
            if (oldUnit === 'galUK') {
                costPerLitre = state.petrolCost / 100 / LITRES_PER_UK_GALLON;
            } else if (oldUnit === 'galUS') {
                costPerLitre = state.petrolCost / 100 / LITRES_PER_US_GALLON;
            }
            
            // Update state
            state.fuelCostUnit = newUnit;
            
            // Convert to new volume unit
            if (newUnit === 'L') {
                state.petrolCost = costPerLitre * 100;
            } else if (newUnit === 'galUK') {
                state.petrolCost = costPerLitre * LITRES_PER_UK_GALLON * 100;
            } else if (newUnit === 'galUS') {
                state.petrolCost = costPerLitre * LITRES_PER_US_GALLON * 100;
            }
            
            elements.petrolCost.value = state.petrolCost;
            updateDisplays();
        });

        elements.evCostUnit.addEventListener('change', (e) => {
            const oldUnit = state.evCostUnit;
            const newUnit = e.target.value;
            
            // Convert the current value to the new unit
            state.evCost = convertEvCost(state.evCost, oldUnit, newUnit);
            state.evCostUnit = newUnit;
            
            updateSliderRanges();
            elements.evCost.value = state.evCost;
            updateDisplays();
        });

        // Usage calculator event listeners
        elements.usageDistance.addEventListener('input', (e) => {
            if (isUpdating) return;
            const value = parseFloat(e.target.value);
            if (!isNaN(value) && value >= 0) {
                state.usageDistance = value;
                // Update the annual distance as the source of truth
                state.usageAnnualDistance = convertUsageToAnnual(value, state.usagePeriod);
                updateDisplays();
            }
        });

        elements.usageDistanceDisplay.addEventListener('blur', (e) => {
            const value = parseFloat(e.target.value);
            if (!isNaN(value) && value >= 0) {
                state.usageDistance = value;
                // Update the annual distance as the source of truth
                state.usageAnnualDistance = convertUsageToAnnual(value, state.usagePeriod);
                elements.usageDistance.value = value;
                updateDisplays();
            } else {
                // Reset to current state value if invalid
                e.target.value = state.usageDistance.toString();
            }
        });

        elements.usagePeriod.addEventListener('change', (e) => {
            // Update period (annual distance stays the same)
            state.usagePeriod = e.target.value;
            
            // Update slider range and current distance for new period
            updateUsageSliderRange();
            
            // Update displays
            updateDisplays();
        });

        elements.outputPeriod.addEventListener('change', (e) => {
            state.outputPeriod = e.target.value;
            updateUsageDisplay();
        });

        // Mode toggle event listener
        elements.modeToggle.addEventListener('click', () => {
            toggleMode();
        });

        // Initialize
        updateSliderRanges();
        updateUsageSliderRange();
        updateDisplays();
    </script>

    <!-- Service Worker Registration -->
    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    console.log('New version available! Please refresh.');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });

            // Listen for installation prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                console.log('PWA install prompt available');
                
                // Optionally show install button/banner here
                // You could create a "Install App" button that calls deferredPrompt.prompt()
            });

            // Track when PWA is installed
            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed successfully');
                deferredPrompt = null;
            });
        }
    </script>
</body>
</html>